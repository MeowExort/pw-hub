<Window x:Class="Pw.Hub.Windows.ModulesLibraryWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:wv2="clr-namespace:Microsoft.Web.WebView2.Wpf;assembly=Microsoft.Web.WebView2.Wpf"
        mc:Ignorable="d"
        Icon="/Assets/icon.png"
        MaxHeight="{Binding Source={x:Static SystemParameters.WorkArea}, Path=Height}"
        MaxWidth="{Binding Source={x:Static SystemParameters.WorkArea}, Path=Width}"
        Title="Библиотека модулей" Height="900" Width="1500" WindowStartupLocation="CenterOwner"
        Style="{StaticResource ModernWindowChrome}">
    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVis"/>
    </Window.Resources>
    <Grid Margin="16">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="450"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>

        <!-- Header -->
        <Border Grid.Row="0" Grid.ColumnSpan="2"
                Style="{StaticResource Panel}"
                Margin="0,0,0,16">
            <TextBlock Text="📚 Библиотека модулей"
                      Style="{StaticResource HeaderMedium}"
                      Margin="0"/>
        </Border>

        <!-- Search and filters -->
        <Border Grid.Row="1" Grid.ColumnSpan="2"
                Style="{StaticResource Card}"
                Margin="0,0,0,12"
                Padding="16">
            <StackPanel>
                <Grid Margin="0,0,0,12">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    <TextBox x:Name="SearchTextBox"
                            Style="{StaticResource ModernTextBox}"
                            Padding="12,10"
                            Grid.Column="0"
                            Margin="0,0,12,0"
                            Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"/>
                    <Button Content="🔍 Найти"
                           Style="{StaticResource PrimaryButton}"
                           Grid.Column="1"
                           MinWidth="120"
                           Padding="16,10"
                           Command="{Binding SearchCommand}"/>
                </Grid>
                <WrapPanel>
                    <TextBox x:Name="TagsTextBox"
                            Style="{StaticResource ModernTextBox}"
                            Width="220"
                            Padding="10,8"
                            Margin="0,0,8,8"
                            ToolTip="Теги через запятую"
                            Text="{Binding TagsText, UpdateSourceTrigger=PropertyChanged}"/>
                    <ComboBox x:Name="SortCombo"
                             Style="{StaticResource ModernComboBox}"
                             Width="180"
                             SelectedIndex="0"
                             Margin="0,0,8,8"
                             SelectedValuePath="Tag"
                             SelectedValue="{Binding SortOption, Mode=TwoWay}">
                        <ComboBoxItem Content="Сортировка: имя" Tag="name"/>
                        <ComboBoxItem Content="Сортировка: установки" Tag="installs"/>
                        <ComboBoxItem Content="Сортировка: запуски" Tag="runs"/>
                        <ComboBoxItem Content="Сортировка: популярные (30д)" Tag="popular"/>
                    </ComboBox>
                    <ComboBox x:Name="OrderCombo"
                             Style="{StaticResource ModernComboBox}"
                             Width="140"
                             SelectedIndex="1"
                             Margin="0,0,8,8"
                             SelectedValuePath="Tag"
                             SelectedValue="{Binding OrderOption, Mode=TwoWay}">
                        <ComboBoxItem Content="По возрастанию" Tag="asc"/>
                        <ComboBoxItem Content="По убыванию" Tag="desc"/>
                    </ComboBox>
                    <Button x:Name="UpdateAllButton"
                           Style="{StaticResource ModernButton}"
                           Content="⟳ Обновить все"
                           MinWidth="130"
                           Padding="12,8"
                           Margin="0,0,0,8"
                           Command="{Binding UpdateAllCommand}"
                           IsEnabled="{Binding CanUpdateAll}"/>
                </WrapPanel>
            </StackPanel>
        </Border>

        <!-- Modules list -->
        <Border Grid.Row="2" Grid.Column="0"
                Style="{StaticResource Card}"
                Margin="0,0,12,0"
                Padding="0">
            <ListView x:Name="ModulesList"
                     Style="{StaticResource ModernListView}"
                     ItemsSource="{Binding Modules}"
                     SelectedItem="{Binding SelectedModule, Mode=TwoWay}"
                     BorderThickness="0"
                     Margin="0 3 0 0"
                     ScrollViewer.HorizontalScrollBarVisibility="Auto">
                <ListView.View>
                    <GridView>
                        <GridViewColumn Header="Модуль" Width="200" DisplayMemberBinding="{Binding Name}"/>
                        <GridViewColumn Header="v" Width="90" DisplayMemberBinding="{Binding Version}"/>
                        <GridViewColumn Header="⬇" Width="60" DisplayMemberBinding="{Binding InstallCount}"/>
                        <GridViewColumn Header="▶" Width="60" DisplayMemberBinding="{Binding RunCount}"/>
                    </GridView>
                </ListView.View>
            </ListView>
        </Border>

        <!-- Details -->
        <Border Grid.Row="2" Grid.Column="1"
                Style="{StaticResource Card}"
                Padding="20">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <TextBlock x:Name="TitleText"
                          Style="{StaticResource HeaderMedium}"
                          Margin="0,0,0,12"
                          Text="{Binding TitleText}"/>

                <Border Grid.Row="1"
                       Background="{StaticResource BackgroundTertiaryBrush}"
                       BorderBrush="{StaticResource BorderBrush}"
                       BorderThickness="1"
                       CornerRadius="4"
                       Margin="0,0,0,16">
                    <wv2:WebView2 x:Name="DescriptionWebView"/>
                </Border>

                <StackPanel Grid.Row="2"
                           Orientation="Horizontal"
                           Margin="0,0,0,12">
                    <Button x:Name="InstallButton"
                           Style="{StaticResource PrimaryButton}"
                           Content="⬇ Установить"
                           MinWidth="130"
                           Padding="16,10"
                           Margin="0,0,8,0"
                           Command="{Binding InstallCommand}"/>
                    <Button x:Name="UninstallButton"
                           Style="{StaticResource ModernButton}"
                           Content="🗑 Удалить"
                           MinWidth="120"
                           Padding="16,10"
                           Margin="0,0,8,0"
                           Command="{Binding UninstallCommand}"/>
                    <Button x:Name="UpdateButton"
                           Style="{StaticResource ModernButton}"
                           Content="⟳ Обновить"
                           MinWidth="120"
                           Padding="16,10"
                           Command="{Binding UpdateSelectedCommand}"
                           IsEnabled="{Binding CanUpdateSelected}"/>
                </StackPanel>

                <!-- Developer panel -->
                <Border x:Name="DevPanel"
                       Grid.Row="3"
                       Background="{StaticResource AccentBlueBrush}"
                       BorderBrush="{StaticResource BorderAccentBrush}"
                       BorderThickness="1"
                       CornerRadius="4"
                       Padding="12"
                       Visibility="{Binding IsDeveloper, Converter={StaticResource BoolToVis}}">
                    <StackPanel>
                        <TextBlock Text="👨‍💻 Режим разработчика"
                                  Style="{StaticResource ModernTextBlock}"
                                  FontWeight="SemiBold"
                                  Foreground="{StaticResource AccentHighlightBrush}"
                                  Margin="0,0,0,12"/>
                        <WrapPanel>
                            <Button Content="➕ Создать"
                                   Style="{StaticResource ModernButton}"
                                   MinWidth="110"
                                   Padding="12,8"
                                   Margin="0,0,8,8"
                                   Command="{Binding CreateModuleCommand}"/>
                            <Button Content="✏ Редактировать"
                                   Style="{StaticResource ModernButton}"
                                   MinWidth="140"
                                   Padding="12,8"
                                   Margin="0,0,8,8"
                                   Command="{Binding EditModuleCommand}"/>
                            <Button Content="🗑 Удалить"
                                    Style="{StaticResource ModernButton}"
                                    MinWidth="110"
                                    Padding="12,8"
                                    Margin="0,0,8,8"
                                    Command="{Binding DeleteModuleCommand}"/>
                            <Button Content=" Редактор Lua"
                                    Style="{StaticResource ModernButton}"
                                    MinWidth="110"
                                    Padding="12,8"
                                    ToolTip="Откроется существующее окно редактора Lua (логика будет перенесена в VM в следующих итерациях)"
                                    Margin="0,0,0,8"
                                    Command="{Binding OpenLuaEditorCommand}"/>
                        </WrapPanel>
                    </StackPanel>
                </Border>
            </Grid>
        </Border>
    </Grid>
</Window>
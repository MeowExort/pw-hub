<Window x:Class="Pw.Hub.Windows.ModulesApiEditorWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:sys="clr-namespace:System;assembly=mscorlib"
        xmlns:wv2="clr-namespace:Microsoft.Web.WebView2.Wpf;assembly=Microsoft.Web.WebView2.Wpf"
        Title="Редактор модуля (API)" Height="900" Width="1450" WindowStartupLocation="CenterOwner"
        Icon="/Assets/icon.png"
        Style="{StaticResource ModernWindowChrome}">
    <Grid Margin="16">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <Border Grid.Row="0"
                Style="{StaticResource Panel}"
                Margin="0,0,0,16">
            <TextBlock Text="📦 Редактор модуля (API)"
                      Style="{StaticResource HeaderMedium}"
                      Margin="0"/>
        </Border>

        <!-- Content -->
        <ScrollViewer x:Name="MainScrollViewer"
                     Grid.Row="1"
                     VerticalScrollBarVisibility="Auto"
                     Margin="0,0,0,16"
                     ScrollChanged="MainScrollViewer_OnScrollChanged">
            <StackPanel>
                <!-- Basic info -->
                <Border Style="{StaticResource Card}">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <TextBlock Text="Основная информация"
                                  Style="{StaticResource HeaderSmall}"/>

                        <Grid Grid.Row="1">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="16"/>
                                <ColumnDefinition Width="200"/>
                            </Grid.ColumnDefinitions>

                            <StackPanel Grid.Column="0">
                                <TextBlock Text="Название"
                                          Style="{StaticResource ModernTextBlock}"
                                          Margin="0,0,0,6"/>
                                <TextBox x:Name="NameText"
                                        Style="{StaticResource ModernTextBox}"
                                        Padding="12,10"/>
                            </StackPanel>

                            <StackPanel Grid.Column="2">
                                <TextBlock Text="Версия"
                                          Style="{StaticResource ModernTextBlock}"
                                          Margin="0,0,0,6"/>
                                <TextBox x:Name="VersionText"
                                        Style="{StaticResource ModernTextBox}"
                                        Padding="12,10"/>
                            </StackPanel>
                        </Grid>
                    </Grid>
                </Border>

                <!-- Description editor -->
                <Border Style="{StaticResource Card}">
                    <DockPanel>
                        <StackPanel DockPanel.Dock="Top" Margin="0,0,0,12">
                            <TextBlock Text="Описание (Markdown)"
                                      Style="{StaticResource HeaderSmall}"/>
                        </StackPanel>

                        <StackPanel DockPanel.Dock="Top"
                                   Orientation="Horizontal"
                                   Margin="0,0,0,12">
                            <CheckBox x:Name="ShowPreviewCheck"
                                     Style="{StaticResource ModernCheckBox}"
                                     Content="Показывать превью"
                                     IsChecked="True"
                                     Margin="0,0,16,0"
                                     Checked="ShowPreviewCheck_OnChanged"
                                     Unchecked="ShowPreviewCheck_OnChanged"/>
                            <Separator Style="{StaticResource ModernSeparator}" Width="2" Height="20" Margin="0,0,16,0"/>
                            <TextBlock Text="Форматирование:"
                                      Style="{StaticResource ModernTextBlock}"
                                      VerticalAlignment="Center"
                                      Margin="0,0,12,0"/>
                            <Button Content="B"
                                   Style="{StaticResource ModernButton}"
                                   Width="32"
                                   Padding="8,6"
                                   Margin="0,0,4,0"
                                   ToolTip="Жирный"
                                   FontWeight="Bold"
                                   Click="Bold_Click"/>
                            <Button Content="I"
                                   Style="{StaticResource ModernButton}"
                                   Width="32"
                                   Padding="8,6"
                                   Margin="0,0,4,0"
                                   ToolTip="Курсив"
                                   FontStyle="Italic"
                                   Click="Italic_Click"/>
                            <Button Content="#"
                                   Style="{StaticResource ModernButton}"
                                   Width="32"
                                   Padding="8,6"
                                   Margin="0,0,4,0"
                                   ToolTip="Заголовок"
                                   Click="Header_Click"/>
                            <Button Content="•"
                                   Style="{StaticResource ModernButton}"
                                   Width="32"
                                   Padding="8,6"
                                   Margin="0,0,4,0"
                                   ToolTip="Список"
                                   Click="List_Click"/>
                            <Button Content="{}"
                                   Style="{StaticResource ModernButton}"
                                   Width="40"
                                   Padding="8,6"
                                   ToolTip="Код"
                                   FontFamily="{StaticResource MonospaceFont}"
                                   Click="Code_Click"/>
                            <Separator Style="{StaticResource ModernSeparator}" Width="2" Height="20" Margin="8,0,8,0"/>
                            <Button x:Name="GenerateDescriptionBtn"
                                   Style="{StaticResource ModernButton}"
                                   Content="🤖 Сгенерировать описание"
                                   MinWidth="200"
                                   Padding="12,8"
                                   ToolTip="Сгенерировать описание модуля с помощью AI"
                                   Click="GenerateDescription_Click"/>
                        </StackPanel>

                        <Grid MinHeight="250" MaxHeight="500">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" MinWidth="150"/>
                                <ColumnDefinition Width="8"/>
                                <ColumnDefinition Width="*" MinWidth="150"/>
                            </Grid.ColumnDefinitions>

                            <Border Grid.Column="0"
                                   Background="{StaticResource BackgroundTertiaryBrush}"
                                   BorderBrush="{StaticResource BorderBrush}"
                                   BorderThickness="1"
                                   CornerRadius="4"
                                   HorizontalAlignment="Stretch">
                                <DockPanel>
                                    <Border DockPanel.Dock="Top"
                                           Background="{StaticResource BackgroundSecondaryBrush}"
                                           BorderBrush="{StaticResource BorderBrush}"
                                           BorderThickness="0,0,0,1"
                                           Padding="8,6">
                                        <TextBlock Text="✏ Редактор"
                                                  Style="{StaticResource ModernTextBlock}"
                                                  FontSize="11"
                                                  Foreground="{StaticResource TextSecondaryBrush}"/>
                                    </Border>
                                    <ScrollViewer VerticalScrollBarVisibility="Auto" Padding="8">
                                        <TextBox x:Name="DescriptionEditor"
                                                Style="{StaticResource ModernTextBox}"
                                                AcceptsReturn="True"
                                                AcceptsTab="True"
                                                TextWrapping="Wrap"
                                                BorderThickness="0"
                                                Background="Transparent"
                                                FontFamily="{StaticResource MonospaceFont}"
                                                FontSize="13"
                                                MinHeight="200"
                                                TextChanged="DescriptionEditor_OnTextChanged"/>
                                    </ScrollViewer>
                                </DockPanel>
                            </Border>

                            <GridSplitter Grid.Column="1"
                                         Width="8"
                                         HorizontalAlignment="Stretch"
                                         VerticalAlignment="Stretch"
                                         ResizeBehavior="PreviousAndNext"
                                         ResizeDirection="Columns"
                                         Background="Transparent"
                                         ShowsPreview="False"/>

                            <Border Grid.Column="2"
                                   x:Name="PreviewContainer"
                                   Background="{StaticResource BackgroundTertiaryBrush}"
                                   BorderBrush="{StaticResource BorderBrush}"
                                   BorderThickness="1"
                                   CornerRadius="4"
                                   ClipToBounds="True"
                                   HorizontalAlignment="Stretch">
                                <Grid ClipToBounds="True">
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="*"/>
                                    </Grid.RowDefinitions>
                                    
                                    <Border Grid.Row="0"
                                           x:Name="PreviewHeader"
                                           Panel.ZIndex="100"
                                           Background="{StaticResource BackgroundSecondaryBrush}"
                                           BorderBrush="{StaticResource BorderBrush}"
                                           BorderThickness="0,0,0,1"
                                           Padding="8,6">
                                        <TextBlock Text="👁 Превью"
                                                  Style="{StaticResource ModernTextBlock}"
                                                  FontSize="11"
                                                  Foreground="{StaticResource TextSecondaryBrush}"/>
                                    </Border>
                                    
                                    <Border Grid.Row="1" ClipToBounds="True">
                                        <wv2:WebView2 x:Name="PreviewWebView"/>
                                    </Border>
                                </Grid>
                            </Border>
                        </Grid>
                    </DockPanel>
                </Border>

                <!-- Script -->
                <Border Style="{StaticResource Card}">
                    <DockPanel>
                        <StackPanel DockPanel.Dock="Top" Margin="0,0,0,12">
                            <TextBlock Text="Lua скрипт"
                                      Style="{StaticResource HeaderSmall}"/>
                            <TextBlock Text="Редактирование скрипта выполняется во встроенном Lua-редакторе"
                                      Style="{StaticResource ModernTextBlock}"
                                      Foreground="{StaticResource TextSecondaryBrush}"/>
                        </StackPanel>
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Left">
                            <Button x:Name="OpenLuaEditorButton"
                                    Style="{StaticResource PrimaryButton}"
                                    Content="🧩 Редактор скрипта"
                                    MinWidth="180"
                                    Padding="12,8"
                                    Click="OpenLuaEditor_Click"/>
                        </StackPanel>
                    </DockPanel>
                </Border>

                <!-- Parameters -->
                <Border Style="{StaticResource Card}">
                    <DockPanel>
                        <StackPanel DockPanel.Dock="Top" Margin="0,0,0,12">
                            <TextBlock Text="Входные параметры"
                                      Style="{StaticResource HeaderSmall}"/>
                        </StackPanel>
                        <StackPanel Orientation="Horizontal"
                                   DockPanel.Dock="Top"
                                   HorizontalAlignment="Right"
                                   Margin="0,0,0,12">
                            <Button x:Name="AddInputButton"
                                   Style="{StaticResource PrimaryButton}"
                                   Content="➕ Добавить"
                                   MinWidth="120"
                                   Padding="12,8"
                                   Margin="0,0,8,0"
                                   Click="AddInput_Click"/>
                            <Button x:Name="RemoveInputButton"
                                   Style="{StaticResource ModernButton}"
                                   Content="🗑 Удалить"
                                   MinWidth="120"
                                   Padding="12,8"
                                   Click="RemoveInput_Click"/>
                        </StackPanel>
                        <DataGrid x:Name="InputsGrid"
                                 Style="{StaticResource ModernDataGrid}"
                                 AutoGenerateColumns="False"
                                 CanUserAddRows="False"
                                 SelectionMode="Single"
                                 MinHeight="150">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="Name" Width="*" MinWidth="180" Binding="{Binding Name, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}">
                                    <DataGridTextColumn.ElementStyle>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="Foreground" Value="{StaticResource TextPrimaryBrush}"/>
                                            <Setter Property="Background" Value="Transparent"/>
                                        </Style>
                                    </DataGridTextColumn.ElementStyle>
                                    <DataGridTextColumn.EditingElementStyle>
                                        <Style TargetType="TextBox" BasedOn="{StaticResource ModernTextBox}">
                                            <Setter Property="Background" Value="{StaticResource BackgroundSecondaryBrush}"/>
                                            <Setter Property="Foreground" Value="{StaticResource TextPrimaryBrush}"/>
                                            <Setter Property="BorderThickness" Value="0"/>
                                            <Setter Property="Padding" Value="8,6"/>
                                            <Setter Property="MinHeight" Value="32"/>
                                        </Style>
                                    </DataGridTextColumn.EditingElementStyle>
                                </DataGridTextColumn>
                                <DataGridTextColumn Header="Label" Width="*" MinWidth="200" Binding="{Binding Label, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}">
                                    <DataGridTextColumn.ElementStyle>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="Foreground" Value="{StaticResource TextPrimaryBrush}"/>
                                            <Setter Property="Background" Value="Transparent"/>
                                        </Style>
                                    </DataGridTextColumn.ElementStyle>
                                    <DataGridTextColumn.EditingElementStyle>
                                        <Style TargetType="TextBox" BasedOn="{StaticResource ModernTextBox}">
                                            <Setter Property="Background" Value="{StaticResource BackgroundSecondaryBrush}"/>
                                            <Setter Property="Foreground" Value="{StaticResource TextPrimaryBrush}"/>
                                            <Setter Property="BorderThickness" Value="0"/>
                                            <Setter Property="Padding" Value="8,6"/>
                                            <Setter Property="MinHeight" Value="32"/>
                                        </Style>
                                    </DataGridTextColumn.EditingElementStyle>
                                </DataGridTextColumn>
                                <DataGridComboBoxColumn Header="Type" SelectedItemBinding="{Binding Type, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" Width="140" MinWidth="140">
                                    <DataGridComboBoxColumn.ItemsSource>
                                        <x:Array Type="{x:Type sys:String}">
                                            <sys:String>string</sys:String>
                                            <sys:String>number</sys:String>
                                            <sys:String>bool</sys:String>
                                            <sys:String>password</sys:String>
                                            <sys:String>squad</sys:String>
                                            <sys:String>squads</sys:String>
                                            <sys:String>account</sys:String>
                                            <sys:String>accounts</sys:String>
                                        </x:Array>
                                    </DataGridComboBoxColumn.ItemsSource>
                                    <DataGridComboBoxColumn.EditingElementStyle>
                                        <Style TargetType="ComboBox" BasedOn="{StaticResource ModernComboBox}">
                                            <Setter Property="Background" Value="{StaticResource BackgroundSecondaryBrush}"/>
                                            <Setter Property="Foreground" Value="{StaticResource TextPrimaryBrush}"/>
                                            <Setter Property="BorderThickness" Value="0"/>
                                        </Style>
                                    </DataGridComboBoxColumn.EditingElementStyle>
                                    <DataGridComboBoxColumn.ElementStyle>
                                        <Style TargetType="ComboBox" BasedOn="{StaticResource ModernComboBox}">
                                            <Setter Property="Background" Value="Transparent"/>
                                            <Setter Property="Foreground" Value="{StaticResource TextPrimaryBrush}"/>
                                            <Setter Property="BorderThickness" Value="0"/>
                                        </Style>
                                    </DataGridComboBoxColumn.ElementStyle>
                                </DataGridComboBoxColumn>
                                <DataGridTextColumn Header="Default" Width="*" MinWidth="160" Binding="{Binding Default, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}">
                                    <DataGridTextColumn.ElementStyle>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="Foreground" Value="{StaticResource TextPrimaryBrush}"/>
                                            <Setter Property="Background" Value="Transparent"/>
                                        </Style>
                                    </DataGridTextColumn.ElementStyle>
                                    <DataGridTextColumn.EditingElementStyle>
                                        <Style TargetType="TextBox" BasedOn="{StaticResource ModernTextBox}">
                                            <Setter Property="Background" Value="{StaticResource BackgroundSecondaryBrush}"/>
                                            <Setter Property="Foreground" Value="{StaticResource TextPrimaryBrush}"/>
                                            <Setter Property="BorderThickness" Value="0"/>
                                            <Setter Property="Padding" Value="8,6"/>
                                            <Setter Property="MinHeight" Value="32"/>
                                        </Style>
                                    </DataGridTextColumn.EditingElementStyle>
                                </DataGridTextColumn>
                                <DataGridCheckBoxColumn Header="Required" Binding="{Binding Required, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" Width="90" MinWidth="90">
                                    <DataGridCheckBoxColumn.ElementStyle>
                                        <Style TargetType="CheckBox">
                                            <Setter Property="HorizontalAlignment" Value="Center"/>
                                            <Setter Property="VerticalAlignment" Value="Center"/>
                                            <Setter Property="Background" Value="Transparent"/>
                                            <Setter Property="Foreground" Value="{StaticResource TextPrimaryBrush}"/>
                                            <Setter Property="BorderBrush" Value="{StaticResource BorderBrush}"/>
                                        </Style>
                                    </DataGridCheckBoxColumn.ElementStyle>
                                </DataGridCheckBoxColumn>
                            </DataGrid.Columns>
                        </DataGrid>
                    </DockPanel>
                </Border>
            </StackPanel>
        </ScrollViewer>

        <!-- Actions -->
        <StackPanel Grid.Row="2"
                   Orientation="Horizontal"
                   HorizontalAlignment="Right">
            <Button Content="Отмена"
                   Style="{StaticResource ModernButton}"
                   MinWidth="120"
                   Padding="16,10"
                   Margin="0,0,8,0"
                   IsCancel="True"/>
            <Button Content="Сохранить"
                   Style="{StaticResource PrimaryButton}"
                   MinWidth="120"
                   Padding="16,10"
                   IsDefault="True"
                   Click="OnSaveClick"/>
        </StackPanel>
    </Grid>
</Window>
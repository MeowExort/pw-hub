# CHANGELOG — Pw.Hub (WPF приложение)

Все значимые изменения в этом проекте документируются в этом файле.

## [0.1.0] — 2025-11-02
Крупное обновление с архитектурным рефакторингом на MVVM, интеграцией Telegram-бота, расширенными возможностями AI-помощника, улучшениями редактора модулей и исправлениями UI.

### Добавлено
- **Интеграция Telegram-бота**:
  - Привязка аккаунта пользователя к Telegram через генерацию уникального state-кода.
  - Эндпоинты для привязки, отвязки, генерации state и получения ссылок для Telegram.
  - TelegramBotHostedService для обработки команд бота (`/start`, `/help`).
  - Кнопки привязки и отвязки Telegram в окне профиля с периодической проверкой статуса привязки.
  - Новая таблица `TelegramLinkStates` и поля для хранения Telegram-данных в таблице `Users`.
- **AI-функционал**:
  - Окно настроек AI (`AiApiKeyWindow`) для управления URL, моделью и ключом API.
  - Сервисы `AiAssistantService` и `AiDocService` для взаимодействия с AI-моделями через Ollama API.
  - Окно предпросмотра изменений кода (`DiffPreviewWindow`) с обновлением в реальном времени.
  - `DiffPreviewService` для формирования unified-diff при работе с AI.
  - Улучшенная обработка AI-сессий, автоматическая отправка и извлечение кода из ответов.
  - Новые правила в промпте AI: все функции и константы должны объявляться в начале скрипта.
  - Улучшенное оформление сообщений для Telegram со смайлами.
- **Редактор модулей и Lua**:
  - Диалог ввода аргументов запуска (`RunArgsWindow`) с динамическими привязками параметров.
  - Дозагрузка полных данных модуля по Id через `EnsureFullModuleLoadedAsync`.
  - Немодальное открытие редактора модулей для параллельной работы с LuaEditor.
  - Свойство `IsSaved` для отслеживания состояния сохранения модуля.
  - Проверка установки модуля (`IsSelectedInstalled`) для управления доступностью кнопок «Установить»/«Удалить».
  - Эндпоинт API `GetModuleEndpoint` для получения информации о модуле.
  - Автоматическое обновление списка модулей после установки/удаления через `TryRefreshOwnerModules`.
  - Асинхронное удаление модулей с отправкой запросов на сервер и метрикой.
  - Метод `ApplyAuthHeader` для авторизации в вызовах API.
- **Поведения и сервисы**:
  - `AutoScrollBehavior` и `AvalonEditTextBehavior` для автопрокрутки текстовых элементов.
  - `EditorBreakpointsBehavior` для управления точками останова в Lua-редакторе.
  - `AccountsService` (`IAccountsService`) для CRUD-операций над отрядами и аккаунтами через EF Core.
  - `TreeViewReorderBehavior` для Drag&Drop реордера элементов TreeView (вынесено из MainWindow).
  - `IAiConfigService` и `AiConfigService` для управления конфигурациями AI.
- **Тестирование и документация**:
  - Детальный тест-план для пользовательского тестирования PW Hub (`TEST_PLAN_USER.md`).

### Изменено
- **Архитектура**:
  - Финальный перевод на MVVM-архитектуру и сервисный слой (один большой коммит рефакторинга).
  - Вынесение бизнес-логики из code-behind в ViewModel и сервисы.
  - Навигационное дерево подключает `TreeViewReorderBehavior` через XAML: `beh:TreeViewReorderBehavior.Enabled="True"`.
  - Регистрация новых сервисов (`AccountsService`, `AiConfigService`, `DiffPreviewService`) в `App.xaml.cs`.
- **Редактор модулей**:
  - Улучшена обработка событий закрытия и сохранения в редакторе модулей и библиотеке.
  - MainWindow возвращается на передний план при закрытии библиотечного окна.
  - Состояние Lua VM синхронизируется с редактором кода через `SetCode`.
  - Оптимизирован метод проверки доступности обновлений в `ModulesLibraryViewModel`.
- **Обработка аргументов**:
  - Улучшена логика обработки аргументов запуска в редакторе модулей и LuaEditor.
  - Динамические привязки параметров в диалоге `RunArgsWindow`.
- **Загрузка персонажей**:
  - CSS-селекторы `#pw_promos_shards` и `#pw_promos_chars` заменены на `.js-shard` и `.js-char`.
  - Добавлен метод `TrimJs` для очистки JSON-строк от лишних символов.
  - Обновлены JavaScript-коды для получения данных о шардах и персонажах.
- **UI и привязки данных**:
  - В `ScriptLogWindow` добавлен режим `OneWay` для свойств `LogText` и `ProgressValue`.
  - Улучшена привязка данных в окнах редакторов.
- **База данных**:
  - Объединены миграции Telegram-интеграции в единую миграцию `AddTelegram`.
  - Обновлена модель БД и снапшот контекста.

### Исправлено
- **UI**:
  - Убран избыточный `ScrollViewer` вокруг `NavigationTree` в `MainWindow.xaml` — TreeView теперь корректно прокручивается при наведении курсора на любую часть содержимого, а не только на сам scrollbar.
  - Перераспределен порядок свойств TreeView для улучшения читаемости кода.
  - Контекстное меню в дереве навигации теперь открывается для элемента, на котором был произведён клик ПКМ, а не для ранее выбранного элемента. При правом клике `ContextMenu` получал `CommandParameter` от `TreeView.SelectedItem`, который не обновлялся при щелчке ПКМ. В итоге команды применялись к ранее выбранному аккаунту/отряду.
  - После создания отряда или аккаунта он автоматически выбирается и прокручивается в область видимости в навигационном дереве.
  - При создании аккаунта теперь автоматически выполняется смена аккаунта в браузере (ChangeAccount) — исправлено отсутствие переключения при программном выборе в дереве.
- **API**:
  - Исправлен метод маршрутизации эндпоинта получения модуля: `MapPost` заменён на `MapGet`.
- **Обработка ошибок**:
  - Улучшена обработка пустых данных при установке и удалении модулей.
  - Защита от конкурентных запросов в `RefreshBindingSafeAsync` при проверке привязки Telegram.

### Технические изменения
- Обновлена версия проекта с 0.0.10 до 0.1.0 в `Pw.Hub.csproj`.

## [0.0.10] — 2025-10-27
Релиз с возможностью редактирования профиля, улучшениями редактора модулей и уточнённой работой Lua‑редактора.

### Добавлено
- Окно «Профиль»: изменение имени пользователя и смена пароля через API.
- Кнопка «Сменить аккаунт» в окне профиля: вход под другим пользователем без автологина по старому токену.
- Редактор модулей (API): кнопка «🧩 Редактор скрипта» вместо поля «Скрипт» — код редактируется в отдельном LuaEditor.
- Редактор модулей (API): кнопка «🤖 Сгенерировать описание» — генерация описания Markdown через AI.
- AI‑генерация описания учитывает предыдущую версию описания и скрипта и добавляет раздел «История изменений».
- LuaEditor: перед запуском/отладкой появляется окно ввода аргументов модуля; введённые значения доступны в скрипте как глобальная таблица `args`.

### Изменено
- LuaEditor: системный промпт AI дополнен разделом «Аргументы запуска (глобальная таблица args)» с примерами и типами значений.
- Хранение авторизации: логика «Remember me» сохраняет только токен; пользователь всегда запрашивается через `/api/auth/me` (уточнение поведения).

### Исправлено
- Мелкие ошибки UI и устойчивость при работе с окнами редакторов и авторизацией.

## [0.0.9] — 2025-10-25
Релиз с интеграцией AI‑чата в Lua‑редактор, улучшениями UX и безопасностью авторизации.

### Добавлено
- AI‑чат в LuaEditor (боковая панель): история сообщений, «Новая сессия», отправка промптов.
- Интеграция с Ollama Cloud: ключ из переменной окружения `OLLAMA_API_KEY` или `config/ai_settings.json`.
- Разбор ответов AI: извлечение кода из блока ```lua ...```; предпросмотр только первых строк в бабле.
- Кнопки в бабле с кодом: «📋 Копировать» и «🔎 Показать полностью» (диалог с полным кодом).
- Git‑подобный unified‑diff с контекстом и подсветкой (RichTextBox) для сравнения с текущим файлом.
- Автоскролл чата к последнему сообщению.
- Возможность изменять высоту областей чата двумя разделителями (GridSplitter): «сообщения ↔ дифф» и «дифф ↔ ввод».
- Поле ввода промпта с переносами строк, внутренними скроллами и возможностью менять высоту.
- Переключатель «AI brave» (подсказка: «AI будет сам вносить изменения в код»): при включении изменения применяются автоматически.
- Сообщение «Нет аргументов запуска» при старте модуля без входных параметров.
- В Lua API аккаунта в Lua проброшено поле `Squad` (Id, Name, OrderIndex).
- Навигация (дерево отрядов и аккаунтов): если список пуст — отображаются кнопки «Добавить отряд» и «Добавить аккаунт» прямо в панели.
- Перетаскивание и упорядочивание: поддержано перемещение отрядов; перемещение аккаунтов внутри отряда; перемещение аккаунтов между отрядами.

### Изменено
- Хранение авторизации: на диск сохраняется только токен; данные пользователя всегда запрашиваются через `/api/auth/me`.
- Вёрстка ввода в AI‑чате: кнопки перенесены под поле ввода; поле растягивается по ширине и не «наезжает» на кнопки.
- Предпросмотр изменений теперь скроллируется (Grid вместо StackPanel для корректных ограничений размера).
- Колонка AI‑панели полностью схлопывается при скрытии (без пустого пространства справа); минимальная ширина панели установлена 500px.
- Настройка GridSplitter: явные `ResizeDirection/Behavior`, отключён `ShowsPreview` в ряде случаев; сплиттер отключается/прячется, если панель скрыта.

### Исправлено
- Устранён `NullReferenceException` в `GridSplitter.OnDragCompleted` при изменении ширины AI‑панели.
- Исправлена логика состояний кнопок «Запустить/Отладка/Остановить»: после завершения скрипта «Остановить» отключается, «Запустить/Отладка» становятся активными.
- Исправлены проблемы вёрстки: поле ввода промпта не уезжает за границы, кнопки не наслаиваются.
- Исправлена прокрутка области «Предпросмотр изменений».

### Прочее
- Улучшены подсказки и автодополнение по объектам Lua API (Account/Squad/Server/Character) в редакторе кода.

## [0.0.8] — 2025-10-24
Добавлен AI‑генератор Lua‑скриптов и улучшен Lua‑редактор (дебагер скриптов, автоскролл консоли вывода, кнопка «Остановить»). 
Исправлена критическая ошибка, из-за которой "перетирались" куки при быстром переключении между аккаунтами: синхронизирован выбор и данные аккаунта в навигации, добавлена безопасная блокировка смены аккаунта без визуальных артефактов.

### Добавлено
- Окно «AI Генератор» для генерации Lua‑скриптов по описанию задачи.
  - Кнопка «AI генератор» в левом меню главного окна.
  - Предпросмотр сгенерированного кода и сохранение в папку Scripts (копируется в выходной каталог).
- Дебагер скриптов: можно ставить точки останова в любом месте скрипта и смотреть значение переменных.
- Автопрокрутка консоли вывода в LuaEditorWindow: новые сообщения автоматически прокручивают лог вниз.
- Кнопка «Остановить» для запуска и отладки в LuaEditorWindow: корректно прерывает выполнение/отладочную сессию.
- Событие CurrentAccountChanged и синхронизация выбора аккаунта в TreeView при ChangeAccountAsync.
- Событие CurrentAccountDataChanged и обновление аватара/имени/SiteId в TreeView при изменении текущего аккаунта.
- Блокировка смены аккаунта из TreeView во время ChangeAccountAsync (CurrentAccountChanging) с безопасной блокировкой кликов без изменения внешнего вида.

### Изменено
- Из окна «AI Генератор» удалён блок «Модуль AI агента» — теперь генерируются только Lua‑скрипты.
- Логика блокировки TreeView переведена с IsEnabled=false на IsHitTestVisible=false и Focusable=false.
- Стили ModernTreeView/TreeViewItem скорректированы: при блокировке визуальный стиль не «светлеет» (Opacity=1, сохранён Foreground).
- Улучшена инициализация подсветки Lua (lua.xshd загружается из ресурсов WPF или из выходной папки).
- Настройка AI: поддержка ключа через переменную окружения OLLAMA_API_KEY и файл config/ai_settings.json.

### Исправлено
- Обновление изображения аккаунта в TreeView при установке AccountManager.CurrentAccount.ImageSource.
- Исключено «светление» левой панели при блокировке на время смены аккаунта.

## [2025-10-23]
### Добавлено
- Отображение текущего времени выполнения в окне выполнения модуля (ScriptLogWindow) с итоговой фиксацией времени по завершении.
- Контекстное меню аккаунта: кнопка «Загрузить персонажей» — автоматическая загрузка серверов и персонажей со страницы pwonline.ru/promo_items.php, сохранение в сущность Account (Servers → Characters).
- Возможность выбрать «персонажа по умолчанию» для каждого сервера в окне редактирования аккаунта.
- Подсветка синтаксиса и автодополнение для Lua‑редактора (AvalonEdit), списки API‑символов.

### Изменено
- Компоненты CheckBox и TextBox, создаваемые динамически в окне параметров модуля (ModuleArgsWindow.BuildUi), теперь используют стили приложения.
- Окно ScriptLogWindow теперь показывается модально при загрузке персонажей.
- Исправлен запуск Lua‑скриптов из LuaEditorWindow: NLua VM сохраняется на время сессии, чтобы callback‑API работали корректно; при закрытии окна VM корректно уничтожается.

### Исправлено
- Защита от исключения при попытке установить DialogResult у немодального окна логов.

---

## История (ранние версии)
- Инициализация проекта, базовая структура UI, интеграция WebView2, локальная база SQLite (EF Core), работа с отрядами и аккаунтами.

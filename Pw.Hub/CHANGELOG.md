# CHANGELOG — Pw.Hub (WPF приложение)

Все значимые изменения в этом проекте документируются в этом файле.

## [0.0.8] — 2025-10-24
Добавлен AI‑генератор Lua‑скриптов и улучшен Lua‑редактор (дебагер скриптов, автоскролл консоли вывода, кнопка «Остановить»). 
Исправлена критическая ошибка, из-за которой "перетирались" куки при быстром переключении между аккаунтами: синхронизирован выбор и данные аккаунта в навигации, добавлена безопасная блокировка смены аккаунта без визуальных артефактов.

### Добавлено
- Окно «AI Генератор» для генерации Lua‑скриптов по описанию задачи.
  - Кнопка «AI генератор» в левом меню главного окна.
  - Предпросмотр сгенерированного кода и сохранение в папку Scripts (копируется в выходной каталог).
- Автопрокрутка консоли вывода в LuaEditorWindow: новые сообщения автоматически прокручивают лог вниз.
- Кнопка «Остановить» для запуска и отладки в LuaEditorWindow: корректно прерывает выполнение/отладочную сессию.
- Событие CurrentAccountChanged и синхронизация выбора аккаунта в TreeView при ChangeAccountAsync.
- Событие CurrentAccountDataChanged и обновление аватара/имени/SiteId в TreeView при изменении текущего аккаунта.
- Блокировка смены аккаунта из TreeView во время ChangeAccountAsync (CurrentAccountChanging) с безопасной блокировкой кликов без изменения внешнего вида.

### Изменено
- Из окна «AI Генератор» удалён блок «Модуль AI агента» — теперь генерируются только Lua‑скрипты.
- Логика блокировки TreeView переведена с IsEnabled=false на IsHitTestVisible=false и Focusable=false.
- Стили ModernTreeView/TreeViewItem скорректированы: при блокировке визуальный стиль не «светлеет» (Opacity=1, сохранён Foreground).
- Улучшена инициализация подсветки Lua (lua.xshd загружается из ресурсов WPF или из выходной папки).
- Настройка AI: поддержка ключа через переменную окружения OLLAMA_API_KEY и файл config/ai_settings.json.

### Исправлено
- Обновление изображения аккаунта в TreeView при установке AccountManager.CurrentAccount.ImageSource.
- Исключено «светление» левой панели при блокировке на время смены аккаунта.

## [2025-10-23]
### Добавлено
- Отображение текущего времени выполнения в окне выполнения модуля (ScriptLogWindow) с итоговой фиксацией времени по завершении.
- Контекстное меню аккаунта: кнопка «Загрузить персонажей» — автоматическая загрузка серверов и персонажей со страницы pwonline.ru/promo_items.php, сохранение в сущность Account (Servers → Characters).
- Возможность выбрать «персонажа по умолчанию» для каждого сервера в окне редактирования аккаунта.
- Подсветка синтаксиса и автодополнение для Lua‑редактора (AvalonEdit), списки API‑символов.

### Изменено
- Компоненты CheckBox и TextBox, создаваемые динамически в окне параметров модуля (ModuleArgsWindow.BuildUi), теперь используют стили приложения.
- Окно ScriptLogWindow теперь показывается модально при загрузке персонажей.
- Исправлен запуск Lua‑скриптов из LuaEditorWindow: NLua VM сохраняется на время сессии, чтобы callback‑API работали корректно; при закрытии окна VM корректно уничтожается.

### Исправлено
- Защита от исключения при попытке установить DialogResult у немодального окна логов.

---

## История (ранние версии)
- Инициализация проекта, базовая структура UI, интеграция WebView2, локальная база SQLite (EF Core), работа с отрядами и аккаунтами.

# CHANGELOG — Pw.Hub (WPF приложение)

Все значимые изменения в этом проекте документируются в этом файле.

## [0.0.9] — 2025-10-25
Релиз с интеграцией AI‑чата в Lua‑редактор, улучшениями UX и безопасностью авторизации.

### Добавлено
- AI‑чат в LuaEditor (боковая панель): история сообщений, «Новая сессия», отправка промптов.
- Интеграция с Ollama Cloud: ключ из переменной окружения `OLLAMA_API_KEY` или `config/ai_settings.json`.
- Разбор ответов AI: извлечение кода из блока ```lua ...```; предпросмотр только первых строк в бабле.
- Кнопки в бабле с кодом: «📋 Копировать» и «🔎 Показать полностью» (диалог с полным кодом).
- Git‑подобный unified‑diff с контекстом и подсветкой (RichTextBox) для сравнения с текущим файлом.
- Автоскролл чата к последнему сообщению.
- Возможность изменять высоту областей чата двумя разделителями (GridSplitter): «сообщения ↔ дифф» и «дифф ↔ ввод».
- Поле ввода промпта с переносами строк, внутренними скроллами и возможностью менять высоту.
- Переключатель «AI brave» (подсказка: «AI будет сам вносить изменения в код»): при включении изменения применяются автоматически.
- Сообщение «Нет аргументов запуска» при старте модуля без входных параметров.
- В Lua API аккаунта в Lua проброшено поле `Squad` (Id, Name, OrderIndex).
- Навигация (дерево отрядов и аккаунтов): если список пуст — отображаются кнопки «Добавить отряд» и «Добавить аккаунт» прямо в панели.
- Перетаскивание и упорядочивание: поддержано перемещение отрядов; перемещение аккаунтов внутри отряда; перемещение аккаунтов между отрядами.

### Изменено
- Хранение авторизации: на диск сохраняется только токен; данные пользователя всегда запрашиваются через `/api/auth/me`.
- Вёрстка ввода в AI‑чате: кнопки перенесены под поле ввода; поле растягивается по ширине и не «наезжает» на кнопки.
- Предпросмотр изменений теперь скроллируется (Grid вместо StackPanel для корректных ограничений размера).
- Колонка AI‑панели полностью схлопывается при скрытии (без пустого пространства справа); минимальная ширина панели установлена 500px.
- Настройка GridSplitter: явные `ResizeDirection/Behavior`, отключён `ShowsPreview` в ряде случаев; сплиттер отключается/прячется, если панель скрыта.

### Исправлено
- Устранён `NullReferenceException` в `GridSplitter.OnDragCompleted` при изменении ширины AI‑панели.
- Исправлена логика состояний кнопок «Запустить/Отладка/Остановить»: после завершения скрипта «Остановить» отключается, «Запустить/Отладка» становятся активными.
- Исправлены проблемы вёрстки: поле ввода промпта не уезжает за границы, кнопки не наслаиваются.
- Исправлена прокрутка области «Предпросмотр изменений».

### Прочее
- Улучшены подсказки и автодополнение по объектам Lua API (Account/Squad/Server/Character) в редакторе кода.

## [0.0.8] — 2025-10-24
Добавлен AI‑генератор Lua‑скриптов и улучшен Lua‑редактор (дебагер скриптов, автоскролл консоли вывода, кнопка «Остановить»). 
Исправлена критическая ошибка, из-за которой "перетирались" куки при быстром переключении между аккаунтами: синхронизирован выбор и данные аккаунта в навигации, добавлена безопасная блокировка смены аккаунта без визуальных артефактов.

### Добавлено
- Окно «AI Генератор» для генерации Lua‑скриптов по описанию задачи.
  - Кнопка «AI генератор» в левом меню главного окна.
  - Предпросмотр сгенерированного кода и сохранение в папку Scripts (копируется в выходной каталог).
- Дебагер скриптов: можно ставить точки останова в любом месте скрипта и смотреть значение переменных.
- Автопрокрутка консоли вывода в LuaEditorWindow: новые сообщения автоматически прокручивают лог вниз.
- Кнопка «Остановить» для запуска и отладки в LuaEditorWindow: корректно прерывает выполнение/отладочную сессию.
- Событие CurrentAccountChanged и синхронизация выбора аккаунта в TreeView при ChangeAccountAsync.
- Событие CurrentAccountDataChanged и обновление аватара/имени/SiteId в TreeView при изменении текущего аккаунта.
- Блокировка смены аккаунта из TreeView во время ChangeAccountAsync (CurrentAccountChanging) с безопасной блокировкой кликов без изменения внешнего вида.

### Изменено
- Из окна «AI Генератор» удалён блок «Модуль AI агента» — теперь генерируются только Lua‑скрипты.
- Логика блокировки TreeView переведена с IsEnabled=false на IsHitTestVisible=false и Focusable=false.
- Стили ModernTreeView/TreeViewItem скорректированы: при блокировке визуальный стиль не «светлеет» (Opacity=1, сохранён Foreground).
- Улучшена инициализация подсветки Lua (lua.xshd загружается из ресурсов WPF или из выходной папки).
- Настройка AI: поддержка ключа через переменную окружения OLLAMA_API_KEY и файл config/ai_settings.json.

### Исправлено
- Обновление изображения аккаунта в TreeView при установке AccountManager.CurrentAccount.ImageSource.
- Исключено «светление» левой панели при блокировке на время смены аккаунта.

## [2025-10-23]
### Добавлено
- Отображение текущего времени выполнения в окне выполнения модуля (ScriptLogWindow) с итоговой фиксацией времени по завершении.
- Контекстное меню аккаунта: кнопка «Загрузить персонажей» — автоматическая загрузка серверов и персонажей со страницы pwonline.ru/promo_items.php, сохранение в сущность Account (Servers → Characters).
- Возможность выбрать «персонажа по умолчанию» для каждого сервера в окне редактирования аккаунта.
- Подсветка синтаксиса и автодополнение для Lua‑редактора (AvalonEdit), списки API‑символов.

### Изменено
- Компоненты CheckBox и TextBox, создаваемые динамически в окне параметров модуля (ModuleArgsWindow.BuildUi), теперь используют стили приложения.
- Окно ScriptLogWindow теперь показывается модально при загрузке персонажей.
- Исправлен запуск Lua‑скриптов из LuaEditorWindow: NLua VM сохраняется на время сессии, чтобы callback‑API работали корректно; при закрытии окна VM корректно уничтожается.

### Исправлено
- Защита от исключения при попытке установить DialogResult у немодального окна логов.

---

## История (ранние версии)
- Инициализация проекта, базовая структура UI, интеграция WebView2, локальная база SQLite (EF Core), работа с отрядами и аккаунтами.
